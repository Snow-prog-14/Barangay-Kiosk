<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Barangay Admin ‚Äî Archive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Custom styles -->
  <link rel="stylesheet" href="../styles/app.css" />
  <link rel="stylesheet" href="../styles/archive.css" />
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <i class="bi bi-grid-1x2"></i>
        <span class="label">Barangay Ugong</span>
      </div>

      <ul class="menu list-unstyled m-0">

    <li class="public-only"><a href="dashboard.html"><i class="bi bi-speedometer2"></i><span class="label">Dashboard</span></a></li>
    <li class="public-only"><a href="requests.html"><i class="bi bi-inboxes"></i><span class="label">Requests</span></a></li>
    <li class="public-only"><a href="types.html"><i class="bi bi-card-checklist"></i><span class="label">Types</span></a></li>
    <li class="admin-only"><a href="users.html"><i class="bi bi-person"></i><span class="label">Users</span></a></li>
    <li class="app-admin-only"><a href="audit.html"><i class="bi bi-shield-check"></i><span class="label">Audit</span></a></li>
    <li class="admin-only"><a href="archive.html"><i class="bi bi-archive"></i><span class="label">Archive</span></a></li>

</ul>



    </aside>

    <div class="main d-flex flex-column">
      <nav class="topbar px-3 py-2 d-flex align-items-center justify-content-between">
        <div class="fw-semibold">Archive Dashboard</div>
        <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </nav>

      <main class="container-fluid py-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2">
              <h2 class="h6 mb-0">üóÑÔ∏è Archived Records</h2>
              <div class="d-flex gap-2">
                <input id="archiveSearch" class="form-control form-control-sm" type="text" placeholder="Search archives..." />
                <select id="archiveFilter" class="form-select form-select-sm" style="width:130px;">
                  <option value="all">All</option>
                  <option value="requests">Requests</option>
                  <option value="citizens">Citizens</option>
                  <option value="types">Types</option>
                </select>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Date Archived</th>
                    <th>Category</th>
                    <th>Details</th>
                    <th>Archived By</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="archiveRows">
                  <tr><td colspan="5" class="text-center text-muted">Loading archives...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

 <script type="module">
import { guard, wireLogout, applyRoleBasedUI, API_URL } from '../scripts/app.js?v=3';

// --- NEW: Get the admin's info ---
const currentUser = JSON.parse(localStorage.getItem('currentUser'));
const adminInfo = {
  admin_user_id: currentUser ? currentUser.id : 0,
  admin_user_name: currentUser ? currentUser.full_name : 'System'
};
// --- END NEW ---
    // --- 1. Page Security ---
    guard();
    wireLogout('logoutBtn');
    document.addEventListener('DOMContentLoaded', () => {
  applyRoleBasedUI();
});


    // --- 2. Get DOM Elements ---
    const tableBody = document.getElementById('archiveRows'); 
    const searchInput = document.getElementById('searchArchives');
    const filterSelect = document.getElementById('archiveFilter');

    // --- 3. Function to Fetch and Render Archives ---
    async function fetchAndRenderArchives() {
      tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';

      const category = filterSelect.value;
      const url = new URL(`${API_URL}/archive.php`);
      url.searchParams.append('t', new Date().getTime());

      if (category && category !== 'all') {
        url.searchParams.append('category', category);
      }
      
      try {
        const response = await fetch(url.toString());
        if (!response.ok) throw new Error('Failed to fetch archives');
        const archives = await response.json();

        tableBody.innerHTML = ''; 

        if (archives.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No archived items found.</td></tr>';
          return;
        }

        archives.forEach(item => {
          const date = item.date_archived !== 'N/A' 
            ? new Date(item.date_archived).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' }) 
            : 'N/A';
            
const row = `
            <tr>
              <td>${date}</td>
              <td><span class="badge bg-secondary">${item.category}</span></td>
              <td>${item.details}</td>
              <td>${item.archived_by}</td>
              <td>
                <button class="btn btn-sm btn-outline-success btn-restore" data-id="${item.action_id}">Restore</button>
                
              
              </td>
            </tr>
          `;
          tableBody.innerHTML += row;
        });

      } catch (error) {
        console.error('Error fetching archives:', error);
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading archives.</td></tr>';
      }
    }

    // --- 4. Handle Permanent Delete ---
    async function handleDeleteClick(actionId) {
      if (!confirm('DANGER: This will permanently delete the item. This action cannot be undone. Are you sure?')) {
        return;
      }
      try {
        const response = await fetch(`${API_URL}/archive.php?id=${actionId}`, {
          method: 'DELETE'
        });
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Failed to delete item');
        }
        alert('Item permanently deleted.');
        fetchAndRenderArchives(); // Refresh the list
      } catch (error) {
        console.error('Delete Error:', error);
        alert(error.message);
      }
    }
    
// --- 5. Handle Restore Click ---
async function handleRestoreClick(actionId) {
  if (!confirm('Are you sure you want to restore this item?')) {
    return;
  }
  try {
    const response = await fetch(`${API_URL}/archive.php`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      // --- THIS BODY IS UPDATED ---
      body: JSON.stringify({ 
        id: actionId,
        admin_user_id: adminInfo.admin_user_id,
        admin_user_name: adminInfo.admin_user_name
      })
      // --- END UPDATE ---
    });
    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error || 'Failed to restore item');
    }
    alert('Item restored successfully.');
    fetchAndRenderArchives(); // Refresh the list
  } catch (error) {
    console.error('Restore Error:', error);
    alert(error.message);
  }
}

    // --- 6. Event Listeners ---
    filterSelect.addEventListener('change', fetchAndRenderArchives);
    
    // Add event listener for the buttons
    tableBody.addEventListener('click', (e) => {
      const button = e.target.closest('button');
      if (!button) return;

      const id = button.dataset.id;
      if (button.classList.contains('btn-delete')) {
        handleDeleteClick(id);
      }
      if (button.classList.contains('btn-restore')) {
        handleRestoreClick(id);
      }
    });
    
    // --- 7. Initial Load ---
    fetchAndRenderArchives();

  </script>
</body>
</html>