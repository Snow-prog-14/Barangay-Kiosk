<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Barangay Admin â€” Change Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="../styles/login.css" />
</head>
<body class="bg-soft">

  <main class="d-flex min-vh-100 align-items-center justify-content-center p-3">
    <div class="auth-wrap" style="max-width:480px;">
      <div class="card shadow-lg rounded-4 overflow-hidden">
        <div class="card-body p-4 p-md-5">
          
          <h2 class="h5 fw-semibold mb-1">Set Your New Password</h2>
          <p class="text-muted small mb-4">
            For security, you must change your temporary password before you can proceed.
          </p>

          <form id="changePasswordForm" novalidate>
            <div class="mb-3">
              <label for="p-new" class="form-label small">New Password</label>
              <input id="p-new" type="password" class="form-control form-control-lg" required />
              <div class="invalid-feedback">Please enter a new password.</div>
            </div>

            <div class="mb-3">
              <label for="p-confirm" class="form-label small">Confirm New Password</label>
              <input id="p-confirm" type="password" class="form-control form-control-lg" required />
              <div class="invalid-feedback">Please confirm your new password.</div>
            </div>
            
            <div id="errMsg" class="alert alert-danger d-none" role="alert">
              Passwords do not match.
            </div>

            <button id="btnSubmit" class="btn btn-primary btn-lg w-100 d-flex align-items-center justify-content-center gap-2" type="submit">
              Set Password and Log In
            </button>
          </form>

        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script type="module">
    import { getCurrentUser, API_URL } from '../scripts/app.js?v=3';

    const user = getCurrentUser();
    
    // --- SPECIAL GUARD ---
    if (!user) {
      // 1. Not logged in at all. Go to login.
      location.href = '../index.html';
    } else if (user.must_change_password === false) {
      // 2. Logged in, but doesn't need to be here. Go to dashboard.
      location.href = 'pages/dashboard.html';
    }
    // 3. Otherwise, user is logged in AND must_change_password is true.
    // They are in the right place, so we do nothing and let the page load.

    // --- FORM HANDLING ---
    const form = document.getElementById('changePasswordForm');
    const newPass = document.getElementById('p-new');
    const confirmPass = document.getElementById('p-confirm');
    const errMsg = document.getElementById('errMsg');
    const btnSubmit = document.getElementById('btnSubmit');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errMsg.classList.add('d-none'); // Hide error
      
      const p1 = newPass.value;
      const p2 = confirmPass.value;

      if (!p1 || !p2) {
        errMsg.textContent = 'Please fill out both fields.';
        errMsg.classList.remove('d-none');
        return;
      }

      if (p1 !== p2) {
        errMsg.textContent = 'Passwords do not match.';
        errMsg.classList.remove('d-none');
        return;
      }
      
      btnSubmit.disabled = true;

      try {
        const response = await fetch(`${API_URL}/password_change.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: user.id, // Send the user's own ID
            new_password: p1,
            confirm_password: p2
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'An unknown error occurred.');
        }

        // --- SUCCESS ---
        // Update the user in localStorage so the dashboard guard works
        user.must_change_password = false;
        localStorage.setItem('currentUser', JSON.stringify(user));
        
        alert('Password changed successfully! You will now be taken to the dashboard.');
        location.href = 'pages/dashboard.html';

      } catch (error) {
        errMsg.textContent = error.message;
        errMsg.classList.remove('d-none');
        btnSubmit.disabled = false;
      }
    });

  </script>
</body>
</html>