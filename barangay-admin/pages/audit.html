<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Barangay Admin — Audit Logs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="../styles/app.css" />
</head>
<body>
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <i class="bi bi-grid-1x2"></i>
        <span class="label">Barangay Ugong</span>
      </div>
      <ul class="menu">
        <li><a href="dashboard.html"><i class="bi bi-speedometer2"></i><span class="label">Dashboard</span></a></li>
        <li><a href="requests.html"><i class="bi bi-inboxes"></i><span class="label">Requests</span></a></li>
        <li><a href="types.html"><i class="bi bi-card-checklist"></i><span class="label">Types</span></a></li>
        <li class="admin-only"><a href="users.html"><i class="bi bi-person"></i><span class="label">Users</span></a></li>
        <li class="app-admin-only active"><a href="audit.html"><i class="bi bi-shield-check"></i><span class="label">Audit Logs</span></a></li>
        <li class="admin-only"><a href="archive.html"><i class="bi bi-archive"></i><span class="label">Archive</span></a></li>
      </ul>
    </aside>

    <!-- MAIN -->
    <div class="main d-flex flex-column">
      <!-- TOPBAR -->
      <nav class="topbar px-3 py-2 d-flex align-items-center justify-content-between">
        <div class="fw-semibold">Audit Logs</div>
        <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </nav>

      <!-- CONTENT -->
      <main class="container-fluid py-4">


        <!-- Filters -->
        <div class="card p-3 mb-4 shadow-sm border-0">
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <input id="searchLogs" class="form-control form-control-sm" type="text" placeholder="Search logs..." style="flex: 1;" />
            <select id="actionFilter" class="form-select form-select-sm" style="width: 180px;">
              <option value="all">All Actions</option>
              <option value="Login">Login</option>
              <option value="Create">Create</option>
              <option value="Edit">Edit</option>
              <option value="Archive">Archive</option>
            </select>
            <button id="clearFilters" class="btn btn-sm btn-success">
              <i class="bi bi-arrow-counterclockwise"></i> Clear
            </button>
          </div>
        </div>

        <!-- Table -->
        <div class="card shadow-sm border-0">
          <div class="table-responsive">
            <table class="table table-hover table-sm align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>User</th>
                  <th>Action</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="auditLogRows">
                <!-- Filled by JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-4 text-muted small">
          © Barangay Ugong Admin Portal
        </div>

      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { guard, wireLogout, applyRoleBasedUI, API_URL } from '../scripts/app.js?v=3';

    guard();
    wireLogout('logoutBtn');
    document.addEventListener('DOMContentLoaded', () => {
  applyRoleBasedUI();
  });


    const tableBody = document.getElementById('auditLogRows');
    const searchInput = document.getElementById('searchLogs');
    const actionFilter = document.getElementById('actionFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');

    async function fetchAndRenderAuditLogs() {
      const query = searchInput.value.trim();
      const action = actionFilter.value;
      const url = new URL(`${API_URL}/audit_logs.php`);
      url.searchParams.append('t', Date.now());
      if (query) url.searchParams.append('q', query);
      if (action && action !== 'all') url.searchParams.append('action', action);

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch audit logs');
        const logs = await response.json();

        tableBody.innerHTML = logs.length
          ? logs.map(log => `
              <tr>
                <td>${new Date(log.date).toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'short' })}</td>
                <td>${log.user}</td>
                <td>${log.action}</td>
                <td>${log.details}</td>
              </tr>
            `).join('')
          : '<tr><td colspan="4" class="text-center text-muted">No audit logs found.</td></tr>';
      } catch (err) {
        console.error(err);
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading audit logs.</td></tr>';
      }
    }

    let searchTimeout;
    searchInput.addEventListener('keyup', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(fetchAndRenderAuditLogs, 400);
    });
    actionFilter.addEventListener('change', fetchAndRenderAuditLogs);
    clearFiltersBtn.addEventListener('click', () => {
      searchInput.value = '';
      actionFilter.value = 'all';
      fetchAndRenderAuditLogs();
    });
    fetchAndRenderAuditLogs();
  </script>
</body>
</html>
