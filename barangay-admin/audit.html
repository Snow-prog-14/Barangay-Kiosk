<!doctype html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <title>Barangay Admin â€” Audit Logs</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
Â  <link rel="stylesheet" href="styles/app.css" />
  Â  <link rel="stylesheet" href="styles/audit.css" />
</head>
<body>
Â  <div class="layout">
Â  Â  <aside class="sidebar">
Â  Â  Â  <div class="brand">
Â  Â  Â  Â  <i class="bi bi-grid-1x2"></i>
Â  Â  Â  Â  <span class="label">Barangay Ugong</span>
Â  Â  Â  </div>
Â  Â  Â  <ul class="menu">
Â  Â  Â  Â  <li><a href="dashboard.html"><i class="bi bi-speedometer2"></i><span class="label">Dashboard</span></a></li>
Â  Â  Â  Â  <li><a href="requests.html"><i class="bi bi-inboxes"></i><span class="label">Requests</span></a></li>
Â  Â  Â  Â  <li class="admin-only"><a href="citizens.html"><i class="bi bi-people"></i><span class="label">Citizens</span></a></li>
Â  Â  Â  Â  <li><a href="types.html"><i class="bi bi-card-checklist"></i><span class="label">Types</span></a></li>
Â  Â  Â  Â  <li class="admin-only"><a href="users.html"><i class="bi bi-person"></i><span class="label">Users</span></a></li>
Â  Â  Â  Â  <li class="admin-only active"><a href="audit.html"><i class="bi bi-shield-check"></i><span class="label">Audit Logs</span></a></li>
Â  Â  Â  Â  <li class="admin-only"><a href="archive.html"><i class="bi bi-archive"></i><span class="label">Archive</span></a></li>
Â  Â  Â  </ul>
Â  Â  </aside>

Â  Â  <div class="main d-flex flex-column">
Â  Â  Â  <nav class="topbar px-3 py-2 d-flex align-items-center justify-content-between">
Â  Â  Â  Â  <div class="fw-semibold">Audit Logs</div>
Â  Â  Â  Â  <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">
Â  Â  Â  Â  Â  <i class="bi bi-box-arrow-right"></i> Logout
Â  Â  Â  Â  </button>
Â  Â  Â  </nav>

Â  Â  Â  <main class="container-fluid py-4">
        
        <div class="audit-header">
          <h1>ğŸ•µï¸ Audit Dashboard</h1>
          <p>Track user actions and system activities</p>
        </div>

        <div class="filter-card">
          <div class="d-flex flex-wrap gap-2">
            <input id="searchLogs" class="form-control" type="text" placeholder="Search logs..." style="flex: 1;" />
            <select id="actionFilter" class="form-select" style="width: 200px;">
              <option value="all">All Actions</option>
              <option value="Login">Login</option>
              <option value="Create">Create</option>
              <option value="Edit">Edit</option>
              <option value="Archive">Archive</option>
              </select>
            <button id="clearFilters" class="btn btn-success">Clear Filters</button>
          </div>
        </div>

        Â  Â  Â  Â  <div class="card results-card">
Â  Â  Â  Â  Â  <div class="table-responsive">
Â  Â  Â  Â  Â  Â  <table class="table table-sm table-hover align-middle">
Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>User</th>
Â   Â  Â  Â  Â  Â  Â  Â  <th>Action</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Details</th>
 Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â   Â  Â  Â  Â  Â  <tbody id="auditLogRows">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
        
        <div class="audit-footer">
          Â© Barangay Ugong Admin Portal
        </div>
Â  Â  Â  </main>
Â  Â  </div>
Â  </div>

Â  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
Â  <script type="module">
Â  Â  import { guard, wireLogout, applyRoleBasedUI, API_URL } from './scripts/app.js?v=3';

Â  Â  // --- 1. Page Security ---
Â  Â  guard();
Â  Â  wireLogout('logoutBtn'); // Correct ID
Â  Â  applyRoleBasedUI();

Â  Â  // --- 2. Get DOM Elements (Correct IDs) ---
Â  Â  const tableBody = document.getElementById('auditLogRows');
Â  Â  const searchInput = document.getElementById('searchLogs');
Â  Â  const actionFilter = document.getElementById('actionFilter');
Â  Â  const clearFiltersBtn = document.getElementById('clearFilters');

Â  Â  // --- 3. Function to Fetch and Render Audit Logs ---
Â  Â  async function fetchAndRenderAuditLogs() {
Â  Â  Â  const query = searchInput.value;
Â  Â  Â  const action = actionFilter.value;

Â  Â  Â  const url = new URL(`${API_URL}/audit_logs.php`);
     Â  Â  url.searchParams.append('t', new Date().getTime()); // Cache buster

Â  Â  Â  if (query) {
Â  Â  Â  Â  url.searchParams.append('q', query);
Â  Â  Â  }
Â  Â  Â  if (action && action !== 'all') { // Matches <option value="all">
Â  Â  Â  Â  url.searchParams.append('action', action);
Â  Â  Â  }

Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(url.toString());
       Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  throw new Error('Failed to fetch audit logs');
Â  Â  Â  Â  }
Â  Â  Â  Â  const logs = await response.json();

Â  Â  Â  Â  tableBody.innerHTML = '';

Â  Â  Â  Â  if (logs.length === 0) {
       Â  Â  Â  tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No audit logs found.</td></tr>';
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  logs.forEach(log => {
Â  Â  Â  Â  Â  const date = new Date(log.date).toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'short' });
Â  Â  Â  Â  Â  const row = `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <td>${date}</td>
Â  Â  Â  Â  Â  Â  Â  <td>${log.user}</td>
Â  Â  Â  Â  Â  Â  Â  <td>${log.action}</td>
Â  Â  Â  Â  Â  Â  Â  <td>${log.details}</td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  tableBody.innerHTML += row;
   Â  Â  Â  });

Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error fetching audit logs:', error);
Â  Â  Â  Â  tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading audit logs.</td></tr>';
Â  Â  Â  }
Â  Â  }

Â  Â  // --- 4. Event Listeners for Filters ---

Â  Â  // Search input (fetch on keyup with a slight delay)
Â  Â  let searchTimeout;
Â  Â  searchInput.addEventListener('keyup', () => {
Â  Â  Â  clearTimeout(searchTimeout);
Â  Â  Â  searchTimeout = setTimeout(fetchAndRenderAuditLogs, 500); // 500ms delay
     Â  });

Â  Â  // Action filter dropdown
Â  Â  actionFilter.addEventListener('change', fetchAndRenderAuditLogs);

Â  Â  // Clear filters button
Â  Â  clearFiltersBtn.addEventListener('click', () => {
Â  Â  Â  searchInput.value = '';
Â  Â  Â  actionFilter.value = 'all'; // Set back to 'all'
     Â  Â  fetchAndRenderAuditLogs();
Â  Â  });

Â  Â  // --- 5. Initial Load ---
Â  Â  fetchAndRenderAuditLogs();

Â  </script>
</body>
</html>